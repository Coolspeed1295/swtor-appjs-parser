var slp = require('./index.js')
  , path = require('path')
  , fs = require('fs')
  , test_log_dir = path.resolve(path.join(__dirname, "test_logs"))
  , parser = new slp.CombatLogParser(test_log_dir)
  ;
  
/*var rstream = fs.createReadStream(path.join(test_log_dir, "test.log"), {end: false}, 'utf8');

rstream.on('data', function (data){
  console.log('data: %s', data);
});

rstream.on('error', function (err){
  console.log("error: %s", err);
});*/


parser.on('start', function (){
  console.log("start");
});

parser.on('stop', function (arg){
  console.log("stop: %s", arg);
});

parser.on('error', function (err){
  console.log(err);
});

var total_dmg = {};
var total_heals = {};
var unknown_events = {};

parser.on('data', function (obj){
  //console.log(obj);
  
  if (obj){
    if (obj.effect.name === "Damage"){
      var identifier;
      if (obj.event_source.is_player || !obj.event_source.unique_id){
        identifier = obj.event_source.name;
      }
      else {
        identifier = obj.event_source.name + ":" + obj.event_source.unique_id;
      }
      
      if (!total_dmg[identifier]) total_dmg[identifier] = 0;
      
      total_dmg[identifier] += obj.effect_value.amt;
    }
    else if (obj.effect.name === "Heal"){
      var identifier;
      if (obj.event_source.is_player || !obj.event_source.unique_id){
        identifier = obj.event_source.name;
      }
      else {
        identifier = obj.event_source.name + ":" + obj.event_source.unique_id;
      }
  
      if (!total_heals[identifier]) total_heals[identifier] = 0;
    
      total_heals[identifier] += obj.effect_value.amt;
    }
    else {
      unknown_events[obj.effect.name] = (unknown_events[obj.effect.name] || 0) + 1;
      console.log(obj);
      console.log();
    }
    
    console.log(total_dmg);
    console.log(total_heals);
    console.log(unknown_events);
    console.log();
  }
  else {
    console.log("data event with no data");
  }
});

parser.on('debug', function (msg){
  console.log("DEBUG: %s", msg);
});

parser.start();
